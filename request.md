## stage and stage local

VM_ENGINE
https://cop-cost-optimization-stage-cost-optimization-engine-srv.cfapps.eu12.hana.ondemand.com


VM_ENGINE_AUTH dev stage ok
https://cost-optimization.authentication.eu12.hana.ondemand.com/oauth/token

RIGHTSIZING_ENGINE
https://cop-cost-optimization-stage-cost-optimization-engine-srv.cfapps.eu12.hana.ondemand.com
https://cop-cost-optimization-dev-cost-optimization-engine-srv.cfapps.eu12.hana.ondemand.com

vm engine 和 rightsizing engine是一模一样的url 尝试何在一起呢


https://cost-optimization-platform-staging.cfapps.eu12.hana.ondemand.com/api/metrics/62f88e9a-b3e7-422c-b68e-db910c01ad5d
hierarchyType pc


/api/metrics/62f88e9a-b3e7-422c-b68e-db910c01ad5d

resource id
62f88e9a-b3e7-422c-b68e-db910c01ad5d

{
    "dates": [
        "2024-09-16T00:00:00.000Z",
        "2024-09-17T00:00:00.000Z",
        "2024-09-18T00:00:00.000Z",
        "2024-09-19T00:00:00.000Z",
        "2024-09-20T00:00:00.000Z",
        "2024-09-21T00:00:00.000Z",
        "2024-09-22T00:00:00.000Z",
        "2024-09-23T00:00:00.000Z",
        "2024-09-24T00:00:00.000Z",
        "2024-09-25T00:00:00.000Z",
        "2024-09-26T00:00:00.000Z",
        "2024-09-27T00:00:00.000Z",
        "2024-09-28T00:00:00.000Z",
        "2024-09-29T00:00:00.000Z",
        "2024-09-30T00:00:00.000Z",
        "2024-10-01T00:00:00.000Z",
        "2024-10-02T00:00:00.000Z",
        "2024-10-03T00:00:00.000Z",
        "2024-10-04T00:00:00.000Z",
        "2024-10-05T00:00:00.000Z",
        "2024-10-06T00:00:00.000Z",
        "2024-10-07T00:00:00.000Z",
        "2024-10-08T00:00:00.000Z",
        "2024-10-09T00:00:00.000Z",
        "2024-10-10T00:00:00.000Z",
        "2024-10-11T00:00:00.000Z",
        "2024-10-12T00:00:00.000Z",
        "2024-10-13T00:00:00.000Z",
        "2024-10-14T00:00:00.000Z",
        "2024-10-15T00:00:00.000Z",
        "2024-10-16T00:00:00.000Z"
    ],
    "metrics": [
        {
            "name": "CPU Utilization",
            "unit": "%",
            "data": {
                "Avg": [
                    6.26580062521709,
                    6.0482131661442,
                    6.383963181660299,
                    7.5733194444444445,
                    5.2375642807505205,
                    4.844292173913043,
                    4.177052083333333,
                    7.027393117831075,
                    7.496742002781642,
                    17.17690625,
                    7.8812990621743655,
                    6.979509735744089,
                    4.820743830378867,
                    4.338279457768508,
                    7.226891281695034,
                    7.4359714980882865,
                    6.319989572471324,
                    6.651157053509381,
                    5.595766423357665,
                    5.075133726988538,
                    4.61104,
                    6.651894150417828,
                    7.193947916666667,
                    8.197214310524487,
                    5.480469401947149,
                    6.059934004862799,
                    5.042207927677329,
                    4.306569241475295,
                    6.11966979492527,
                    7.132563478260869,
                    9.560479166666667
                ],
                "Max": [
                    49.36,
                    32.61,
                    38.91,
                    57.34,
                    32.02,
                    54.11,
                    42.08,
                    50.26,
                    44.55,
                    47.91,
                    36.68,
                    37.56,
                    52.67,
                    41.09,
                    58.44,
                    62.98,
                    42.89,
                    44.83,
                    35.09,
                    54.43,
                    46.87,
                    46.74,
                    38.47,
                    40.77,
                    45.99,
                    47.26,
                    51.65,
                    36.53,
                    65.22,
                    63.86,
                    53.95
                ],
                "Min": [
                    0.54,
                    0.68,
                    0.71,
                    0.8,
                    0.54,
                    0.57,
                    0.46,
                    0.54,
                    0.61,
                    1.07,
                    1.44,
                    0.64,
                    0.56,
                    0.38,
                    0.55,
                    0.74,
                    0.62,
                    0.62,
                    0.55,
                    0.42,
                    0.53,
                    0.55,
                    0.68,
                    0.53,
                    0.1,
                    0.55,
                    0.6,
                    0.51,
                    0.43,
                    0.62,
                    0.64
                ]
            }
        },
        {
            "name": "Memory Utilization",
            "unit": "%",
            "data": {
                "Avg": [
                    50.032537653595114,
                    50.8487899464626,
                    51.64737018301674,
                    50.63471856966157,
                    50.13697062228616,
                    50.85270252534007,
                    50.83481200879141,
                    50.75674299071644,
                    51.187461330974294,
                    52.38542479876311,
                    53.29361331254863,
                    53.2832613834078,
                    54.654579384399014,
                    53.92274620142284,
                    52.349112188913644,
                    52.84299708728686,
                    53.08032810712241,
                    53.49310251145955,
                    53.43458570116042,
                    54.6925814583131,
                    54.06917772844513,
                    54.413678875415734,
                    55.27162534237399,
                    55.23628721368535,
                    50.68848834279209,
                    31.62815142240491,
                    36.305838301879156,
                    36.50677377158832,
                    40.171673863543994,
                    41.671521132797686,
                    44.34401213857318
                ],
                "Max": [
                    51.75683393017729,
                    53.18386473856629,
                    53.20602056301387,
                    53.72074828976105,
                    52.04664114690391,
                    53.65864674331963,
                    52.37890323901593,
                    52.24368496274409,
                    53.51803378725591,
                    54.95043418390288,
                    56.610740983106375,
                    56.12085387493577,
                    56.25376373008736,
                    55.47861097282888,
                    55.35859816610997,
                    56.06118620728417,
                    55.48377982881552,
                    56.067157992356115,
                    56.15018587808325,
                    56.74621017471737,
                    55.52636016187051,
                    56.83039227100463,
                    57.07980211812693,
                    58.08587226201182,
                    57.343689780318606,
                    34.73629299685252,
                    38.64256808838643,
                    38.174761530061666,
                    43.75358808934995,
                    43.78598125963515,
                    51.0201214028777
                ],
                "Min": [
                    48.47656751830678,
                    49.69167523124358,
                    50.60267355312179,
                    45.92744331320658,
                    49.210670526079134,
                    49.422493255395686,
                    49.23558641925745,
                    47.574175592561666,
                    50.18356966212744,
                    51.36891881584018,
                    52.056451936664956,
                    52.45626043807811,
                    52.679826005267216,
                    52.40931417812179,
                    48.291216357271324,
                    52.23389926451696,
                    52.15920176804985,
                    52.60186660939106,
                    52.46893166270555,
                    52.926024136048305,
                    52.78443261016187,
                    52.785837736061154,
                    54.156036220131035,
                    54.49773272899537,
                    2.0467415130395685,
                    28.711088049203493,
                    33.73963217818602,
                    34.434466935380264,
                    35.28986241810124,
                    37.9461525645555,
                    41.09591790853032
                ]
            }
        },
        {
            "name": "Network In",
            "unit": "KB",
            "data": {
                "Avg": [
                    57137.30586412218,
                    56933.53195224338,
                    58486.21891716851,
                    65257.80329725477,
                    56966.11711595323,
                    55041.4494803656,
                    54734.937727186414,
                    57533.44564887153,
                    59680.11357625326,
                    73046.21773444282,
                    70914.45462951661,
                    65280.6072644306,
                    53043.33047756619,
                    54712.49142320421,
                    57669.36446872287,
                    61448.785351901584,
                    78748.71909213596,
                    51861.18830283074,
                    50516.36205003526,
                    41886.20258043077,
                    42034.78001946343,
                    47072.03860677083,
                    43329.53761494954,
                    48998.8734676316,
                    42638.367328219945,
                    46848.10636698405,
                    41852.44334208171,
                    46487.06052517361,
                    44860.92119547526,
                    50812.18141735254,
                    217895.59885559083
                ],
                "Max": [
                    1288593.6904296875,
                    3288607.1376953125,
                    3481810.779296875,
                    3458757.6708984375,
                    3761149.076171875,
                    3682246.486328125,
                    3023263.6767578125,
                    1218307.8046875,
                    1294917.9501953125,
                    3440436.5078125,
                    3259250.919921875,
                    4249352.787109375,
                    3291230.94140625,
                    1177500.287109375,
                    1116118.115234375,
                    3812716.2822265625,
                    3397343.5703125,
                    3579304.3486328125,
                    4147086.552734375,
                    3711125.015625,
                    1117763.1923828125,
                    2985511.12109375,
                    2250689.044921875,
                    3055962.626953125,
                    3508011.1025390625,
                    4233301.3330078125,
                    3766743.109375,
                    3763357.904296875,
                    1295468.6083984375,
                    4355728.283203125,
                    4087428.595703125
                ],
                "Min": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0
                ]
            }
        },
        {
            "name": "Network Out",
            "unit": "KB",
            "data": {
                "Avg": [
                    1135083.6999440512,
                    1153555.9380323621,
                    1158096.7933336047,
                    1170918.9912865532,
                    1137246.4494666206,
                    1128345.1216047658,
                    1085954.817154609,
                    1139387.3808512369,
                    1143796.0235761853,
                    1171533.667775472,
                    1172558.252094523,
                    1143038.9273648558,
                    1124877.5842885335,
                    1091474.5671084933,
                    1131306.1818769667,
                    1133303.1284830729,
                    1150694.152222697,
                    1149376.583918547,
                    1112536.9665622287,
                    1124162.2876519097,
                    1073248.2942915175,
                    1117431.6920332166,
                    1143048.3636661107,
                    1140903.536280756,
                    1086904.0657691108,
                    1107811.7881754558,
                    1111933.5187588162,
                    1076380.7465877957,
                    1109837.9392618814,
                    1150837.1707501546,
                    1182593.3148919
                ],
                "Max": [
                    8404322.130859375,
                    8912662.1796875,
                    10209131.145507812,
                    11866843.262695312,
                    7698768.0029296875,
                    13294049.8046875,
                    7840536.5224609375,
                    8261680.9287109375,
                    8561844.059570312,
                    9464060.994140625,
                    18234989.923828125,
                    8050928.384765625,
                    11823879.985351562,
                    8935320.556640625,
                    11037315.16015625,
                    10927545.029296875,
                    9426593.4296875,
                    12302576.396484375,
                    10356630.744140625,
                    12594410.49609375,
                    8163698.8857421875,
                    8632837.8359375,
                    8929007.357421875,
                    8787141.48046875,
                    10817124.08203125,
                    8517879.03125,
                    16175548.526367188,
                    8372703.5048828125,
                    8766225.499023438,
                    8218943.8486328125,
                    13561832.3046875
                ],
                "Min": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0
                ]
            }
        }
    ]
}



### 调用rightsizing url 拿到数据看看 具体的流程
现在数据都是走stage的注意哦
metrics.service line 62
metricsData = await this.queryMetricsByRightsizingEngine(queryDto, resource)


  const resource = await this.rightSizingService.findRightSizingResourceInScope(user, resourceId);
  从stage 的 rightsizing api 获得 resource 数据

  从本地缓存读取metricskey 判断是否有缓存数据
  没有的话判断 是否vm 是的话 判断是azure 还是 aws
  走azure的
  queryMetricsByRightsizingEngine resource进入 queryDto 是查询的时间范围


  先看看gcp是否能正常返回数据

  vm id 先换成gcp 看看正确什么样的

  用jetbrain和cursor和vscode 生成单元测试 从controller 到 service
  metricsQuery
  {
    "metrics": [],
    "hierarchyType": "pc",
    "to": "2024-10-16T16:00:00Z",
    "granularity": "1d"
  }

  resourceId
  "64c75226-be24-4bc7-9e21-a0b80ff1875f"


  能不能去掉cronjob 为何修改一行代码如此困难
https://cop-cost-optimization-stage-cost-optimization-engine-srv.cfapps.eu12.hana.ondemand.com/rightsizing/VM_DAILY_METRICS?$filter=(vm_platformId eq '1392583628260826507' and day ge 2023-10-18 and day le 2024-10-16)&$orderby=day



https://cop-cost-optimization-stage-cost-optimization-engine-srv.cfapps.eu12.hana.ondemand.com/rightsizing/VM_DAILY_METRICS?$filter=(vm_platformId eq '/subscriptions/0ea89fa8-210b-4a83-a0ad-ecc31f973cee/resourcegroups/rg-dht/providers/microsoft.compute/virtualmachines/spwdfvml3729' and day ge 2023-10-18 and day le 2024-10-16)&$orderby=day

查询 cost optiomiaztion engijne上有多少platform id


## credstore 流程

VM_ENGINE_URL=https://cop-cost-optimization-stage-cost-optimization-engine-srv.cfapps.eu12.hana.ondemand.com
VM_ENGINE_AUTH_URL=https://cost-optimization.authentication.eu12.hana.ondemand.com/oauth/token
# VM_ENGINE_CREDENTIALS={"username":"sb-cop-rightsizing-dev!t70125","password":"d1p7oEBZNmW2k+/7awzYZ6LCazA="}
VM_ENGINE_CREDENTIALS={"username":"sb-cop-rightsizing-stage!t70125","password":"SaXi3qArtBXCGEFHV7+cJZfaK1s="}

COST_ESTIMATOR_BASE_URL=https://cost-estimator-api.cfapps.eu12.hana.ondemand.com

https://cost-optimization.authentication.eu12.hana.ondemand.com/oauth/token
{
  "grant_type": "client_credentials",
  "client_id": "sb-cop-rightsizing-stage!t70125",
  "client_secret": "SaXi3qArtBXCGEFHV7+cJZfaK1s="
}


https://cop-cost-optimization-stage-cost-optimization-engine-srv.cfapps.eu12.hana.ondemand.com

'Authorization': `Bearer ${this.connectionSetting.token}`,
'Accept': 'application/json'

https://cop-cost-optimization-stage-cost-optimization-engine-srv.cfapps.eu12.hana.ondemand.com/rightsizing/VM_DAILY_METRICS?$filter=(vm_platformId eq '1392583628260826507' and day ge 2023-10-18 and day le 2024-10-16)&$orderby=day
